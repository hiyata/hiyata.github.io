---
layout: default
title: PV Loop Sandbox
---

<div id="pvloop-app" style="max-width:1400px;margin:0 auto;padding:1.25rem"></div>

<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script crossorigin src="https://unpkg.com/react-is@18/umd/react-is.development.js"></script>
<script crossorigin src="https://unpkg.com/recharts/umd/Recharts.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
  :root{--ink:#0f172a;--muted:#64748b;--grid:#e5e7eb;--green:#059669;--red:#dc2626;--blue:#2563eb;--purple:#7c3aed;}
  body{color:var(--ink)}
  .wrap{display:grid;grid-template-columns:1fr;gap:24px;max-width:100%;}
  @media(min-width:1024px){.wrap{grid-template-columns:minmax(320px, 400px) 1fr;gap:32px}}
  .section h2{font:600 12px/1.1 ui-sans-serif,system-ui;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin:0 0 8px}
  .stack{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:12px;align-items:center}
  .flex1{flex:1}
  .field{display:flex;flex-direction:column;gap:6px}
  .label{font-size:12px;color:var(--muted)}
  input[type="range"]{width:100%}
  input[type="number"],select,button{border:1px solid var(--grid);border-radius:6px;padding:6px 8px;font-size:14px}
  button{cursor:pointer;background:#fff}
  button:hover{background:#f8fafc}
  button.primary{background:var(--blue);color:white;font-weight:600}
  button.primary:hover{background:#1d4ed8}
  .mode-toggle{display:flex;gap:0;border:1px solid var(--grid);border-radius:6px;overflow:hidden;margin-bottom:16px}
  .mode-toggle button{border:none;border-radius:0;padding:8px 16px;background:white}
  .mode-toggle button.active{background:var(--blue);color:white}
  .quiz-option{padding:12px;border:2px solid var(--grid);border-radius:6px;cursor:pointer;transition:all 0.2s}
  .quiz-option:hover{border-color:var(--blue);background:#f8fafc}
  .quiz-option.correct{border-color:var(--green);background:#f0fdf4}
  .quiz-option.incorrect{border-color:var(--red);background:#fef2f2}
  .quiz-option.disabled{cursor:not-allowed;opacity:0.6}
  .score-display{display:flex;gap:16px;padding:12px;background:#f8fafc;border-radius:6px;font-weight:600}
  .divider{height:1px;background:var(--grid);margin:12px 0}
  .metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .metric .k{color:var(--muted);font-size:12px}
  .metric .v{font-weight:600;font-size:18px}
  .metric .d{font-size:12px;color:var(--muted)}
  .slider-group{background:#f8fafc;padding:12px;border-radius:6px;margin-bottom:8px}
</style>

<script type="text/babel" data-presets="env,react">
const {useState, useMemo} = React;
const {LineChart, Line, CartesianGrid, XAxis, YAxis, Tooltip, ReferenceLine, ResponsiveContainer, Scatter, ScatterChart} = Recharts;

const BASELINE = {
  preload: 100, // EDV baseline
  afterload: 100, // Arterial pressure
  contractility: 100, // Ees (ESPVR slope)
  hr: 75
};

function generatePVLoop(params){
  const {preload, afterload, contractility} = params;
  
  // Scale factors
  const edv = 50 + (preload / 100) * 80; // EDV: 50-130 mL
  const ees = 1.0 + (contractility / 100) * 1.5; // ESPVR slope: 1.0-2.5
  const arterialP = 60 + (afterload / 100) * 60; // 60-120 mmHg
  
  // ESPVR: P = Ees * (V - V0), where V0 ≈ 20
  const v0 = 20;
  const espvr = (v) => ees * (v - v0);
  
  // Find ESV where LV pressure = arterial pressure
  // arterialP = ees * (esv - v0)
  const esv = (arterialP / ees) + v0;
  
  // Points of the loop
  const points = [];
  
  // 1. Filling (diastole): from ESV to EDV at low pressure
  const fillingSteps = 20;
  for(let i = 0; i <= fillingSteps; i++){
    const v = esv + (edv - esv) * (i / fillingSteps);
    const p = 5 + 10 * Math.pow(i / fillingSteps, 2); // passive filling pressure
    points.push({v, p, phase: 'filling'});
  }
  
  // 2. Isovolumic contraction: EDV constant, pressure rises
  const ivcSteps = 15;
  const pStart = points[points.length - 1].p;
  for(let i = 1; i <= ivcSteps; i++){
    const p = pStart + (espvr(edv) - pStart) * (i / ivcSteps);
    points.push({v: edv, p, phase: 'ivc'});
  }
  
  // 3. Ejection: from EDV to ESV along ESPVR
  const ejectionSteps = 25;
  for(let i = 1; i <= ejectionSteps; i++){
    const v = edv - (edv - esv) * (i / ejectionSteps);
    const p = espvr(v);
    points.push({v, p, phase: 'ejection'});
  }
  
  // 4. Isovolumic relaxation: ESV constant, pressure drops
  const ivrSteps = 15;
  const pEnd = points[points.length - 1].p;
  for(let i = 1; i < ivrSteps; i++){
    const p = pEnd - (pEnd - 5) * (i / ivrSteps);
    points.push({v: esv, p, phase: 'ivr'});
  }
  
  // Close the loop
  points.push(points[0]);
  
  // Calculate metrics
  const sv = edv - esv;
  const ef = (sv / edv) * 100;
  const co = (sv * params.hr) / 1000; // L/min
  const sw = points.reduce((sum, pt, i) => {
    if(i === 0) return 0;
    const prev = points[i - 1];
    return sum + ((pt.p + prev.p) / 2) * (pt.v - prev.v);
  }, 0) / 1000; // Stroke work in J (simplified)
  
  // ESPVR line
  const espvrLine = [];
  for(let v = v0; v <= 150; v += 5){
    espvrLine.push({v, p: espvr(v)});
  }
  
  // EDPVR (passive filling curve)
  const edpvrLine = [];
  for(let v = 40; v <= 150; v += 5){
    edpvrLine.push({v, p: 5 + 0.015 * Math.pow(v - 40, 1.8)});
  }
  
  return {
    loop: points,
    espvr: espvrLine,
    edpvr: edpvrLine,
    metrics: {
      edv: Math.round(edv),
      esv: Math.round(esv),
      sv: Math.round(sv),
      ef: Math.round(ef),
      co: co.toFixed(1),
      sw: Math.abs(sw).toFixed(1)
    }
  };
}

function ExploreMode(){
  const [preload, setPreload] = useState(100);
  const [afterload, setAfterload] = useState(100);
  const [contractility, setContractility] = useState(100);
  const [hr, setHr] = useState(75);
  const [showESPVR, setShowESPVR] = useState(true);
  const [showEDPVR, setShowEDPVR] = useState(true);
  const [showBaseline, setShowBaseline] = useState(true);
  
  const currentLoop = useMemo(() => generatePVLoop({preload, afterload, contractility, hr}), [preload, afterload, contractility, hr]);
  const baselineLoop = useMemo(() => generatePVLoop({...BASELINE}), []);
  
  const resetAll = () => {
    setPreload(100);
    setAfterload(100);
    setContractility(100);
    setHr(75);
  };
  
  return (
    <div className="wrap">
      <section className="section">
        <h2>Controls</h2>
        <div className="stack">
          <div className="slider-group">
            <div className="field">
              <label className="label">Preload (EDV): {preload}%</label>
              <input type="range" min="50" max="150" value={preload} onChange={(e) => setPreload(+e.target.value)}/>
              <div style={{fontSize: 11, color: 'var(--muted)', marginTop: 4}}>
                Frank-Starling: ↑ preload → ↑ SV (up to a point)
              </div>
            </div>
          </div>
          
          <div className="slider-group">
            <div className="field">
              <label className="label">Afterload (Arterial Pressure): {afterload}%</label>
              <input type="range" min="50" max="150" value={afterload} onChange={(e) => setAfterload(+e.target.value)}/>
              <div style={{fontSize: 11, color: 'var(--muted)', marginTop: 4}}>
                ↑ afterload → ↑ ESV, ↓ SV (harder to eject)
              </div>
            </div>
          </div>
          
          <div className="slider-group">
            <div className="field">
              <label className="label">Contractility (ESPVR slope): {contractility}%</label>
              <input type="range" min="50" max="200" value={contractility} onChange={(e) => setContractility(+e.target.value)}/>
              <div style={{fontSize: 11, color: 'var(--muted)', marginTop: 4}}>
                ↑ contractility → steeper ESPVR, ↓ ESV, ↑ SV
              </div>
            </div>
          </div>
          
          <div className="slider-group">
            <div className="field">
              <label className="label">Heart Rate: {hr} bpm</label>
              <input type="range" min="40" max="180" value={hr} onChange={(e) => setHr(+e.target.value)}/>
              <div style={{fontSize: 11, color: 'var(--muted)', marginTop: 4}}>
                Affects CO = SV × HR
              </div>
            </div>
          </div>
          
          <button onClick={resetAll}>Reset to Baseline</button>
          
          <div className="divider"></div>
          
          <div className="stack" style={{fontSize: 13}}>
            <label>
              <input type="checkbox" checked={showESPVR} onChange={(e) => setShowESPVR(e.target.checked)}/>
              {' '}Show ESPVR (contractility line)
            </label>
            <label>
              <input type="checkbox" checked={showEDPVR} onChange={(e) => setShowEDPVR(e.target.checked)}/>
              {' '}Show EDPVR (passive filling)
            </label>
            <label>
              <input type="checkbox" checked={showBaseline} onChange={(e) => setShowBaseline(e.target.checked)}/>
              {' '}Show baseline loop
            </label>
          </div>
        </div>
      </section>
      
      <section className="section">
        <h2>Pressure-Volume Loop</h2>
        <div style={{width: '100%'}}>
          <ResponsiveContainer width="100%" height={500}>
            <ScatterChart margin={{top: 20, right: 40, bottom: 60, left: 60}}>
              <CartesianGrid strokeDasharray="3 3"/>
              <XAxis 
                type="number" 
                dataKey="v" 
                domain={[0, 160]}
                label={{value: 'LV Volume (mL)', position: 'insideBottom', offset: -10}}
              />
              <YAxis 
                type="number" 
                dataKey="p" 
                domain={[0, 200]}
                label={{value: 'LV Pressure (mmHg)', angle: -90, position: 'insideLeft'}}
              />
              <Tooltip cursor={{strokeDasharray: '3 3'}}/>
              
              {showBaseline && (
                <Scatter 
                  data={baselineLoop.loop} 
                  line={{stroke: '#94a3b8', strokeWidth: 2, strokeDasharray: '5 5'}}
                  lineType="joint"
                  fill="none"
                  shape="circle"
                  isAnimationActive={false}
                />
              )}
              
              {showESPVR && (
                <Scatter 
                  data={currentLoop.espvr} 
                  line={{stroke: '#dc2626', strokeWidth: 2, strokeDasharray: '3 3'}}
                  lineType="joint"
                  fill="none"
                  shape="circle"
                  isAnimationActive={false}
                />
              )}
              
              {showEDPVR && (
                <Scatter 
                  data={currentLoop.edpvr} 
                  line={{stroke: '#7c3aed', strokeWidth: 2, strokeDasharray: '3 3'}}
                  lineType="joint"
                  fill="none"
                  shape="circle"
                  isAnimationActive={false}
                />
              )}
              
              <Scatter 
                data={currentLoop.loop} 
                line={{stroke: '#2563eb', strokeWidth: 3}}
                lineType="joint"
                fill="#2563eb"
                shape="circle"
                isAnimationActive={false}
              />
            </ScatterChart>
          </ResponsiveContainer>
        </div>
        
        <div className="metrics" style={{marginTop: 20}}>
          <div className="metric">
            <div className="k">EDV (End-Diastolic Volume)</div>
            <div className="v">{currentLoop.metrics.edv} mL</div>
            <div className="d">Δ {currentLoop.metrics.edv - baselineLoop.metrics.edv} vs baseline</div>
          </div>
          <div className="metric">
            <div className="k">ESV (End-Systolic Volume)</div>
            <div className="v">{currentLoop.metrics.esv} mL</div>
            <div className="d">Δ {currentLoop.metrics.esv - baselineLoop.metrics.esv} vs baseline</div>
          </div>
          <div className="metric">
            <div className="k">SV (Stroke Volume)</div>
            <div className="v">{currentLoop.metrics.sv} mL</div>
            <div className="d">Δ {currentLoop.metrics.sv - baselineLoop.metrics.sv} vs baseline</div>
          </div>
          <div className="metric">
            <div className="k">EF (Ejection Fraction)</div>
            <div className="v">{currentLoop.metrics.ef}%</div>
            <div className="d">Δ {currentLoop.metrics.ef - baselineLoop.metrics.ef}% vs baseline</div>
          </div>
          <div className="metric">
            <div className="k">CO (Cardiac Output)</div>
            <div className="v">{currentLoop.metrics.co} L/min</div>
            <div className="d">@ {hr} bpm</div>
          </div>
          <div className="metric">
            <div className="k">SW (Stroke Work, approx)</div>
            <div className="v">{currentLoop.metrics.sw} J</div>
            <div className="d">Loop area</div>
          </div>
        </div>
        
        <div style={{marginTop: 20, padding: 12, background: '#f8fafc', borderRadius: 6, fontSize: 13}}>
          <strong>Key Concepts:</strong>
          <ul style={{marginTop: 8, marginBottom: 0, paddingLeft: 20}}>
            <li><strong>ESPVR</strong> (red dashed) = End-Systolic Pressure-Volume Relationship. Slope represents contractility.</li>
            <li><strong>EDPVR</strong> (purple dashed) = End-Diastolic Pressure-Volume Relationship. Shows passive filling compliance.</li>
            <li><strong>Frank-Starling:</strong> Increased preload → increased stretch → increased contractile force → increased SV.</li>
            <li><strong>Afterload:</strong> Higher arterial pressure → more work to eject → decreased SV, increased ESV.</li>
          </ul>
        </div>
      </section>
    </div>
  );
}

function QuizMode(){
  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [showResult, setShowResult] = useState(false);
  const [score, setScore] = useState(0);
  const [questionsAnswered, setQuestionsAnswered] = useState(0);
  
  const questionTypes = [
    {
      type: 'preload',
      generate: () => {
        const change = Math.random() > 0.5 ? 'increase' : 'decrease';
        const params = change === 'increase' 
          ? {preload: 150, afterload: 100, contractility: 100, hr: 75}
          : {preload: 60, afterload: 100, contractility: 100, hr: 75};
        
        return {
          question: `What happens to Stroke Volume when preload ${change}s?`,
          params,
          correctAnswer: change === 'increase' ? 'increases' : 'decreases',
          options: ['increases', 'decreases', 'stays the same', 'doubles'].sort(() => Math.random() - 0.5),
          explanation: `${change === 'increase' ? 'Increased' : 'Decreased'} preload ${change === 'increase' ? 'increases' : 'decreases'} EDV via Frank-Starling mechanism, which ${change === 'increase' ? 'increases' : 'decreases'} the force of contraction and SV.`
        };
      }
    },
    {
      type: 'afterload',
      generate: () => {
        const change = Math.random() > 0.5 ? 'increase' : 'decrease';
        const params = change === 'increase'
          ? {preload: 100, afterload: 140, contractility: 100, hr: 75}
          : {preload: 100, afterload: 60, contractility: 100, hr: 75};
        
        return {
          question: `What happens to ESV when afterload ${change}s?`,
          params,
          correctAnswer: change === 'increase' ? 'increases' : 'decreases',
          options: ['increases', 'decreases', 'stays the same', 'eliminates'].sort(() => Math.random() - 0.5),
          explanation: `${change === 'increase' ? 'Increased' : 'Decreased'} afterload makes it ${change === 'increase' ? 'harder' : 'easier'} to eject blood, so ESV ${change === 'increase' ? 'increases' : 'decreases'} and SV ${change === 'increase' ? 'decreases' : 'increases'}.`
        };
      }
    },
    {
      type: 'contractility',
      generate: () => {
        const change = Math.random() > 0.5 ? 'increase' : 'decrease';
        const params = change === 'increase'
          ? {preload: 100, afterload: 100, contractility: 160, hr: 75}
          : {preload: 100, afterload: 100, contractility: 60, hr: 75};
        
        return {
          question: `What happens to the ESPVR slope when contractility ${change}s?`,
          params,
          correctAnswer: change === 'increase' ? 'steeper' : 'flatter',
          options: ['steeper', 'flatter', 'unchanged', 'inverts'].sort(() => Math.random() - 0.5),
          explanation: `${change === 'increase' ? 'Increased' : 'Decreased'} contractility makes the ESPVR ${change === 'increase' ? 'steeper' : 'flatter'}, reflecting ${change === 'increase' ? 'stronger' : 'weaker'} contraction for the same volume.`
        };
      }
    },
    {
      type: 'combined',
      generate: () => {
        const scenarios = [
          {
            name: 'Exercise',
            params: {preload: 120, afterload: 90, contractility: 140, hr: 120},
            effect: 'CO increases significantly'
          },
          {
            name: 'Hypertension',
            params: {preload: 100, afterload: 140, contractility: 100, hr: 75},
            effect: 'ESV increases, SV decreases'
          },
          {
            name: 'Heart Failure',
            params: {preload: 130, afterload: 110, contractility: 60, hr: 90},
            effect: 'SV and EF decrease'
          },
          {
            name: 'Beta-blocker',
            params: {preload: 100, afterload: 100, contractility: 85, hr: 55},
            effect: 'HR and CO decrease'
          }
        ];
        
        const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
        const wrongAnswers = scenarios.filter(s => s.name !== scenario.name).map(s => s.effect);
        const options = [scenario.effect, ...wrongAnswers.slice(0, 3)].sort(() => Math.random() - 0.5);
        
        return {
          question: `In the scenario of "${scenario.name}", what would you expect?`,
          params: scenario.params,
          correctAnswer: scenario.effect,
          options,
          explanation: `${scenario.name}: ${scenario.effect}`
        };
      }
    }
  ];
  
  const generateQuestion = () => {
    const qType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
    return qType.generate();
  };
  
  useMemo(() => {
    if(!currentQuestion) setCurrentQuestion(generateQuestion());
  }, [currentQuestion]);
  
  const handleAnswer = (answer) => {
    if(showResult) return;
    setSelectedAnswer(answer);
    setShowResult(true);
    setQuestionsAnswered(q => q + 1);
    if(answer === currentQuestion.correctAnswer){
      setScore(s => s + 1);
    }
  };
  
  const nextQuestion = () => {
    setCurrentQuestion(generateQuestion());
    setSelectedAnswer(null);
    setShowResult(false);
  };
  
  const resetQuiz = () => {
    setScore(0);
    setQuestionsAnswered(0);
    setCurrentQuestion(generateQuestion());
    setSelectedAnswer(null);
    setShowResult(false);
  };
  
  if(!currentQuestion) return <div>Loading...</div>;
  
  const currentLoop = useMemo(() => generatePVLoop(currentQuestion.params), [currentQuestion]);
  const baselineLoop = useMemo(() => generatePVLoop({...BASELINE}), []);
  
  return (
    <div className="wrap">
      <section className="section">
        <h2>Quiz Settings</h2>
        <div className="stack">
          <div className="score-display">
            <div>Score: {score}/{questionsAnswered}</div>
            <div>{questionsAnswered > 0 ? `${Math.round(score/questionsAnswered*100)}%` : '—'}</div>
          </div>
          
          <button onClick={resetQuiz}>Reset Quiz</button>
          
          <div className="divider"></div>
          
          <div>
            <h3 style={{marginBottom: 12, fontSize: 14, fontWeight: 600}}>
              {currentQuestion.question}
            </h3>
            <div className="stack">
              {currentQuestion.options.map(opt => (
                <button
                  key={opt}
                  className={`quiz-option ${showResult ? (opt === currentQuestion.correctAnswer ? 'correct' : opt === selectedAnswer ? 'incorrect' : '') : ''} ${showResult ? 'disabled' : ''}`}
                  onClick={() => handleAnswer(opt)}
                  disabled={showResult}
                >
                  {opt}
                </button>
              ))}
            </div>
          </div>
          
          {showResult && (
            <>
              <div style={{padding: 12, background: selectedAnswer === currentQuestion.correctAnswer ? '#f0fdf4' : '#fef2f2', borderRadius: 6, fontWeight: 600}}>
                {selectedAnswer === currentQuestion.correctAnswer ? '✓ Correct!' : '✗ Incorrect'}
              </div>
              <div style={{padding: 12, background: '#f8fafc', borderRadius: 6, fontSize: 13}}>
                <strong>Explanation:</strong> {currentQuestion.explanation}
              </div>
              <button className="primary" onClick={nextQuestion}>Next Question</button>
            </>
          )}
          
          <div className="divider"></div>
          
          <div className="metrics">
            <div className="metric">
              <div className="k">SV</div>
              <div className="v">{currentLoop.metrics.sv} mL</div>
            </div>
            <div className="metric">
              <div className="k">EF</div>
              <div className="v">{currentLoop.metrics.ef}%</div>
            </div>
            <div className="metric">
              <div className="k">CO</div>
              <div className="v">{currentLoop.metrics.co} L/min</div>
            </div>
            <div className="metric">
              <div className="k">EDV</div>
              <div className="v">{currentLoop.metrics.edv} mL</div>
            </div>
          </div>
        </div>
      </section>
      
      <section className="section">
        <h2>PV Loop Comparison</h2>
        <div style={{width: '100%'}}>
          <ResponsiveContainer width="100%" height={500}>
            <ScatterChart margin={{top: 20, right: 40, bottom: 60, left: 60}}>
              <CartesianGrid strokeDasharray="3 3"/>
              <XAxis 
                type="number" 
                dataKey="v" 
                domain={[0, 160]}
                label={{value: 'LV Volume (mL)', position: 'insideBottom', offset: -10}}
              />
              <YAxis 
                type="number" 
                dataKey="p" 
                domain={[0, 200]}
                label={{value: 'LV Pressure (mmHg)', angle: -90, position: 'insideLeft'}}
              />
              <Tooltip cursor={{strokeDasharray: '3 3'}}/>
              
              <Scatter 
                data={baselineLoop.loop} 
                line={{stroke: '#94a3b8', strokeWidth: 2, strokeDasharray: '5 5'}}
                lineType="joint"
                fill="none"
                shape="circle"
                name="Baseline"
                isAnimationActive={false}
              />
              
              <Scatter 
                data={currentLoop.espvr} 
                line={{stroke: '#dc2626', strokeWidth: 2, strokeDasharray: '3 3'}}
                lineType="joint"
                fill="none"
                shape="circle"
                name="ESPVR"
                isAnimationActive={false}
              />
              
              <Scatter 
                data={currentLoop.loop} 
                line={{stroke: '#2563eb', strokeWidth: 3}}
                lineType="joint"
                fill="#2563eb"
                shape="circle"
                name="Modified"
                isAnimationActive={false}
              />
            </ScatterChart>
          </ResponsiveContainer>
        </div>
      </section>
    </div>
  );
}

function App(){
  const [mode, setMode] = useState('explore');
  
  return (
    <>
      <div className="mode-toggle">
        <button className={mode === 'explore' ? 'active' : ''} onClick={() => setMode('explore')}>Explore Mode</button>
        <button className={mode === 'quiz' ? 'active' : ''} onClick={() => setMode('quiz')}>Quiz Mode</button>
      </div>
      {mode === 'explore' ? <ExploreMode/> : <QuizMode/>}
    </>
  );
}

ReactDOM.createRoot(document.getElementById('pvloop-app')).render(<App/>);
</script>