---
layout: default
title: Flow Diagram Trainer
---

<div id="flow-app" style="max-width:1400px;margin:0 auto;padding:1.25rem"></div>

<!-- React + ReactDOM (UMD) -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

<script crossorigin src="https://unpkg.com/react-is@18/umd/react-is.development.js"></script>

<!-- Recharts (UMD) -->
<script crossorigin src="https://unpkg.com/recharts/umd/Recharts.js"></script>

<!-- Babel (compile JSX in the browser) -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
  :root{--ink:#0f172a;--muted:#64748b;--grid:#e5e7eb;--green:#059669;--red:#dc2626;--blue:#2563eb;}
  body{color:var(--ink)}
  .wrap{display:grid;grid-template-columns:1fr;gap:24px;max-width:100%;}
  @media(min-width:1024px){.wrap{grid-template-columns:minmax(300px, 420px) 1fr;gap:32px}}
  .section h2{font:600 12px/1.1 ui-sans-serif,system-ui;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin:0 0 8px}
  .stack{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:12px;align-items:center}
  .flex1{flex:1}
  .field{display:flex;flex-direction:column;gap:6px}
  .label{font-size:12px;color:var(--muted)}
  input[type="range"]{width:100%}
  input[type="number"],select,button{border:1px solid var(--grid);border-radius:6px;padding:6px 8px;font-size:14px}
  button{cursor:pointer;background:#fff}
  button:hover{background:#f8fafc}
  button.primary{background:var(--blue);color:white;font-weight:600}
  button.primary:hover{background:#1d4ed8}
  .legend{display:flex;gap:16px;align-items:center;margin:6px 0 10px;font-size:14px}
  .pill{display:inline-flex;gap:8px;align-items:center}
  .pill .line{width:32px;height:2px;background:var(--ink);display:inline-block}
  .pill .dash{width:32px;height:0;border-top:2px dashed #94a3b8;display:inline-block}
  .divider{height:1px;background:var(--grid);margin:12px 0}

  .mode-toggle{display:flex;gap:0;border:1px solid var(--grid);border-radius:6px;overflow:hidden}
  .mode-toggle button{border:none;border-radius:0;padding:8px 16px;background:white}
  .mode-toggle button.active{background:var(--blue);color:white}

  .score-display{display:flex;gap:16px;padding:12px;background:#f8fafc;border-radius:6px;font-weight:600}

  .quiz-option{padding:12px;border:2px solid var(--grid);border-radius:6px;cursor:pointer;transition:all 0.2s;width:100%}
  .quiz-option:hover{border-color:var(--blue);background:#f8fafc}
  .quiz-option.correct{border-color:var(--green);background:#f0fdf4}
  .quiz-option.incorrect{border-color:var(--red);background:#fef2f2}
  .quiz-option.disabled{cursor:not-allowed;opacity:0.6}
  .quiz-options-grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media (min-width: 520px){ .quiz-options-grid{grid-template-columns:1fr 1fr} }

  /* Insights panel */
  .insights{background:#f8fafc;border:1px solid var(--grid);border-radius:6px;padding:12px}

  /* Confetti canvas */
  #confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:9999}
</style>

{% raw %}
<script type="text/babel" data-presets="env,react">
const {useMemo,useState,useEffect,useRef} = React;
const {LineChart,Line,CartesianGrid,XAxis,YAxis,Tooltip,ReferenceArea,ReferenceLine,ResponsiveContainer,Legend} = Recharts;

/* ---------------- Utilities ---------------- */
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const ms=(x)=>Number(x.toFixed(1));

/* ------------------------------------------------------------
   Synthetic FLOW MAKER (LV perspective)
   - Transmitral inflow (E then A) shown as positive (m/s)
   - Aortic outflow shown as positive (m/s) on a separate series
   - Time base in milliseconds over one beat; we can tile 2 beats
   - Parameters:
       rr, pr, qrs, ivct, et, ivrt, diastasis, e_amp, a_amp
   ------------------------------------------------------------ */
function g(x, mu, sigma, amp){ const z=(x-mu)/sigma; return amp*Math.exp(-0.5*z*z); }

function makeFlowBeat({rr, pr, qrs, ivct, et, ivrt, diastasis, e_amp, a_amp, e_width, a_width, fs=500}){
  // constraints from physiology (Wiggers timing & phases)
  rr = clamp(rr, 400, 2000);
  pr = clamp(pr, 120, 240);
  qrs = clamp(qrs, 70, 140);
  ivct = clamp(ivct, 30, 120); // isovolumic contraction time
  et = clamp(et, 180, 380);    // ejection time
  ivrt = clamp(ivrt, 50, 140); // isovolumic relaxation time
  e_amp = clamp(e_amp, 0.3, 1.8);
  a_amp = clamp(a_amp, 0.2, 1.6);
  e_width = clamp(e_width, 25, 120);
  a_width = clamp(a_width, 25, 120);

  // Landmark events within a beat (t=0 is P-wave onset-like anchor):
  const dt = 1000/fs;
  const n = Math.round(rr/dt);
  const tP = 0;
  const tQRS = pr; // ventricular depol after PR
  const tMC = tQRS + 10; // mitral closes ~shortly after QRS (E-C coupling lag)
  const tAO = tQRS + ivct; // aortic opens after IVCT
  const tAC = tAO + et;    // aortic closes after ET
  const tMO = tAC + ivrt;  // mitral opens after IVRT

  // E and A centers
  const tE = tMO + 60;     // early rapid filling center
  const tA = rr - 80;      // late atrial filling center (right before next P)
  const data = [];
  for(let i=0;i<n;i++){
    const t=i*dt; // ms
    const mitralFlow =
      g(t, tE, e_width, e_amp) +
      g(t, tA, a_width, a_amp);
    const aorticFlow =
      (t>=tAO && t<=tAC)
        ? g(t, (tAO+tAC)/2, et*0.22, 1.8)  // bell-shaped ejection
        : 0;
    data.push({t: ms(t), mitral: mitralFlow, aortic: aorticFlow});
  }

  // Metrics: E/A, ET, IVCT, IVRT, diastasis
  const mitralIdxMaxE = data.reduce((m,p,i)=> p.mitral>data[m].mitral?i:m, 0);
  const mitralIdxMaxA = data.reduce((m,p,i)=> (p.t>tMO+120 && p.mitral>data[m].mitral)?i:m, mitralIdxMaxE);
  const E = data[mitralIdxMaxE]?.mitral ?? 0;
  const A = data[mitralIdxMaxA]?.mitral ?? 0;
  const ea = E>0 && A>0 ? E/A : null;
  const metrics = {
    rr, pr, qrs, ivct, et, ivrt,
    diastasis: Math.max(0, (tA - (tE + e_width*2))), 
    E, A, EA: ea ? Number(ea.toFixed(2)) : null,
    tAO, tAC, tMO, tE, tA
  };

  return {data, metrics};
}

function tileBeats(beat, beats=2){
  const out=[], rr=beat.metrics.rr;
  for(let b=0;b<beats;b++){
    beat.data.forEach(p=>{
      out.push({t: ms(p.t + b*rr), mitral: p.mitral, aortic: p.aortic});
    });
  }
  return out;
}

/* ---------------- Insights ---------------- */
function flowInsights(base, cur){
  const lines=[];
  if(!base || !cur) return lines;
  const dEA = (cur.EA??0) - (base.EA??0);
  const dIVCT = cur.ivct - base.ivct;
  const dIVRT = cur.ivrt - base.ivrt;
  const dET = cur.et - base.et;
  const dRR = cur.rr - base.rr;
  const dDiast = cur.diastasis - base.diastasis;

  if(cur.EA!=null && base.EA!=null){
    if(Math.abs(dEA)>=0.15){
      lines.push(`${dEA>0?'Higher':'Lower'} E/A ratio (${dEA>0?'+':'-'}${Math.abs(dEA).toFixed(2)}) → ${dEA>0?'enhanced early filling or reduced atrial kick':'reliance on atrial kick/impeded early filling'}.`);
    }
  }
  if(Math.abs(dIVCT)>=10){
    lines.push(`${dIVCT>0?'Prolonged':'Shortened'} IVCT (${dIVCT>0?'+':'-'}${Math.abs(dIVCT)} ms) → ${dIVCT>0?'slower pressure rise or ↑afterload':'faster pressure rise or ↑inotropy'}.`);
  }
  if(Math.abs(dET)>=15){
    lines.push(`${dET>0?'Longer':'Shorter'} ejection time (${dET>0?'+':'-'}${Math.abs(dET)} ms) → ${dET>0?'sustained outflow':'reduced outflow (↑afterload/↓inotropy)'} .`);
  }
  if(Math.abs(dIVRT)>=10){
    lines.push(`${dIVRT>0?'Prolonged':'Shortened'} IVRT (${dIVRT>0?'+':'-'}${Math.abs(dIVRT)} ms) → ${dIVRT>0?'slower relaxation/↑afterload':'faster relaxation or ↓afterload'}.`);
  }
  if(Math.abs(dRR)>=50){
    lines.push(`${dRR>0?'Longer':'Shorter'} cycle length (${dRR>0?'+':'-'}${Math.abs(dRR)} ms) → ${dRR>0?'slower HR':'faster HR'} with ${dDiast>0?'more':'less'} diastasis.`);
  }
  if(lines.length===0) lines.push('Minimal change in global inflow/outflow pattern.');
  return lines;
}

/* ---------------- Confetti ---------------- */
function useConfettiOn(trigger){
  useEffect(()=>{
    if(!trigger) return;
    let raf=0, t0=null;
    const canvas=document.getElementById('confetti-canvas') || (()=> {
      const c=document.createElement('canvas');
      c.id='confetti-canvas';
      document.body.appendChild(c);
      const onResize=()=>{ c.width=window.innerWidth; c.height=window.innerHeight; };
      onResize(); window.addEventListener('resize', onResize);
      c._cleanup=()=>window.removeEventListener('resize', onResize);
      return c;
    })();
    const ctx=canvas.getContext('2d');
    const N=140;
    const parts=[...Array(N)].map(()=>({
      x: Math.random()*canvas.width,
      y: -20 - Math.random()*canvas.height*0.3,
      vx: -1 + Math.random()*2,
      vy: 2 + Math.random()*3.5,
      s: 4 + Math.random()*4,
      a: Math.random()*Math.PI*2,
      spin: (-0.2+Math.random()*0.4)
    }));

    function step(ts){
      if(t0==null) t0=ts;
      const dt=(ts-t0)/1000;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      parts.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.a+=p.spin;
        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.a);
        ctx.globalAlpha=0.9;
        ctx.fillStyle = `hsl(${(p.x/10 + p.y/5)%360},70%,55%)`;
        ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s);
        ctx.restore();
        if(p.y>canvas.height+40) { p.y=-20; p.x=Math.random()*canvas.width; }
      });
      if(dt<1.6){ raf=requestAnimationFrame(step); }
      else { ctx.clearRect(0,0,canvas.width,canvas.height); }
    }
    raf=requestAnimationFrame(step);
    return ()=>{ cancelAnimationFrame(raf); if(canvas._cleanup) canvas._cleanup(); };
  },[trigger]);
}

/* ---------------- Explore Mode ---------------- */
function ExploreMode(){
  const [hr, setHr] = useState(70);          // bpm
  const [preload, setPreload] = useState(100);  // % baseline affects E amp
  const [afterload, setAfterload] = useState(100); // % baseline affects IVCT, ET
  const [inotropy, setInotropy] = useState(100);  // % baseline affects IVCT (down), ET (up)
  const [showBaseline,setShowBaseline]=useState(true);

  const rr = Math.round(60000/Math.max(30, Math.min(180, hr))); // ms

  const baseParams = useMemo(()=>({
    rr,
    pr: 160,
    qrs: 90,
    ivct: 60,
    et: 280,
    ivrt: 80,
    diastasis: 150,
    e_amp: 1.2, a_amp: 0.8, e_width: 50, a_width: 55
  }),[rr]);

  const modParams = useMemo(()=>{
    // Physiologic heuristics, aligned to lecture framing (valve/phase timing).
    const p = {...baseParams};
    const kPre = preload/100, kAft = afterload/100, kIno = inotropy/100;

    // Preload mainly boosts E amplitude/width; A rises if low preload
    p.e_amp = p.e_amp * (0.8 + 0.6*kPre);
    p.a_amp = p.a_amp * (kPre<0.9 ? 1.1 : 0.95);
    p.e_width = p.e_width * (0.9 + 0.25*kPre);

    // Afterload ↑ → IVCT↑, ET↓, IVRT↑
    p.ivct = clamp(p.ivct * (0.8 + 0.5*kAft), 30, 140);
    p.et   = clamp(p.et   * (1.1 - 0.25*(kAft-1)), 180, 360);
    p.ivrt = clamp(p.ivrt * (0.9 + 0.4*kAft), 50, 150);

    // Inotropy ↑ → IVCT↓, ET↑(slightly)
    p.ivct = clamp(p.ivct * (1.1 - 0.2*(kIno-1)), 30, 140);
    p.et   = clamp(p.et   * (1.0 + 0.08*(kIno-1)), 180, 380);

    // Faster HR → less diastasis
    const baseDiast = baseParams.diastasis;
    p.diastasis = clamp(baseDiast * (rr/900), 0, 250);
    if(rr<650){ p.a_width = p.a_width*0.9; }

    return p;
  },[baseParams, preload, afterload, inotropy, rr]);

  const baseBeat = useMemo(()=>makeFlowBeat(baseParams),[baseParams]);
  const modBeat  = useMemo(()=>makeFlowBeat(modParams), [modParams]);

  const base2 = useMemo(()=>tileBeats(baseBeat,2),[baseBeat]);
  const mod2  = useMemo(()=>tileBeats(modBeat,2), [modBeat]);

  const insights = useMemo(()=>flowInsights(baseBeat.metrics, modBeat.metrics),[baseBeat,modBeat]);

  return (
    <div className="wrap">
      <section className="section">
        <h2>Controls</h2>
        <div className="stack">
          <div className="row">
            <div className="field flex1">
              <label className="label">Heart rate (bpm): {hr}</label>
              <input type="range" min="30" max="180" step="1" value={hr} onChange={(e)=>setHr(+e.target.value)} />
            </div>
            <div className="field" style={{width:110}}>
              <label className="label">Show baseline</label>
              <label style={{fontSize:14}}>
                <input type="checkbox" checked={showBaseline} onChange={(e)=>setShowBaseline(e.target.checked)} /> Baseline
              </label>
            </div>
          </div>
          <div className="row">
            <div className="field flex1">
              <label className="label">Preload (%): {preload}</label>
              <input type="range" min="60" max="160" step="5" value={preload} onChange={(e)=>setPreload(+e.target.value)} />
            </div>
            <div className="field flex1">
              <label className="label">Afterload (%): {afterload}</label>
              <input type="range" min="60" max="160" step="5" value={afterload} onChange={(e)=>setAfterload(+e.target.value)} />
            </div>
          </div>
          <div className="row">
            <div className="field flex1">
              <label className="label">Inotropy (%): {inotropy}</label>
              <input type="range" min="60" max="160" step="5" value={inotropy} onChange={(e)=>setInotropy(+e.target.value)} />
            </div>
          </div>

          <div className="divider"></div>

          {/* Insights */}
          <div className="insights">
            <div style={{fontWeight:700, marginBottom:6}}>Insights (plain language)</div>
            <ul style={{margin:'6px 0 0 18px',fontSize:14}}>
              {insights.map((s,i)=><li key={i}>{s}</li>)}
            </ul>
            <div style={{marginTop:8, fontSize:13, color:'var(--muted)'}}>
              Metrics — E/A: <b>{modBeat.metrics.EA??'—'}</b>, IVCT: <b>{modBeat.metrics.ivct} ms</b>,
              ET: <b>{modBeat.metrics.et} ms</b>, IVRT: <b>{modBeat.metrics.ivrt} ms</b>,
              Diastasis: <b>{Math.round(modBeat.metrics.diastasis)} ms</b>
            </div>
          </div>
        </div>
      </section>

      <section className="section">
        <h2>LV Flow Diagram</h2>
        <div className="legend">
          <span className="pill"><span className="line"></span> Modified (current)</span>
          <span className="pill"><span className="dash"></span> Baseline</span>
        </div>

        <div style={{width:'100%'}}>
          <ResponsiveContainer width="100%" height={420}>
            <LineChart data={mod2} margin={{top:8,right:30,bottom:20,left:25}}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis type="number" dataKey="t" domain={[0,'dataMax']} tickCount={10}
                     label={{value:'time (ms)', position:'insideBottomRight', offset:-10}}/>
              <YAxis domain={[0,2.4]} tickCount={6}
                     label={{value:'flow (m/s)', angle:-90, position:'insideLeft'}}/>
              <Tooltip formatter={(v, n)=>`${n}: ${Number(v).toFixed(2)} m/s`} labelFormatter={(l)=>`${Number(l).toFixed(0)} ms`} />
              {showBaseline && (
                <>
                  <Line dot={false} type="monotone" dataKey="mitral" data={base2} name="Transmitral (baseline)" stroke="#94a3b8" strokeWidth={2} strokeDasharray="6 4"/>
                  <Line dot={false} type="monotone" dataKey="aortic" data={base2} name="Aortic (baseline)" stroke="#94a3b8" strokeWidth={2} strokeDasharray="4 3"/>
                </>
              )}
              <Line dot={false} type="monotone" dataKey="mitral" name="Transmitral" stroke="#0f172a" strokeWidth={3}/>
              <Line dot={false} type="monotone" dataKey="aortic" name="Aortic" stroke="#2563eb" strokeWidth={3}/>
              {/* Valve timing guides (first beat) */}
              <ReferenceLine x={modBeat.metrics.tAO} stroke="#e5e7eb" />
              <ReferenceLine x={modBeat.metrics.tAC} stroke="#e5e7eb" />
              <ReferenceLine x={modBeat.metrics.tMO} stroke="#e5e7eb" />
              <Legend />
            </LineChart>
          </ResponsiveContainer>
        </div>
        <div style={{fontSize:12, color:'var(--muted)', marginTop:6}}>
          Guides: vertical lines ≈ Aortic open/close &amp; Mitral open (schematic). Phases and valve timing follow Wiggers framework.
        </div>
      </section>
    </div>
  );
}

/* ---------------- Quiz Mode ---------------- */
function QuizMode(){
  const [quizType, setQuizType] = useState('phase'); // 'phase' | 'hemo'
  const [difficulty, setDifficulty] = useState('standard'); // 'easy' (2) | 'standard' (4)
  const nOptions = difficulty==='easy'? 2 : 4;

  const [hr, setHr] = useState(70);
  const [current, setCurrent] = useState(null);
  const [selected, setSelected] = useState(null);
  const [showResult, setShowResult] = useState(false);
  const [score, setScore] = useState(0);
  const [answered, setAnswered] = useState(0);

  const rr = Math.round(60000/Math.max(30, Math.min(180, hr)));

  const baseParams = useMemo(()=>({
    rr, pr:160, qrs:90, ivct:60, et:280, ivrt:80, diastasis:150,
    e_amp:1.2, a_amp:0.8, e_width:50, a_width:55
  }),[rr]);

  const hemoScenarios = [
    { key:'HR↑',   mutate:(p)=>({...p, rr: Math.round(p.rr*0.75)}) },
    { key:'Preload↑', mutate:(p)=>({...p, e_amp:p.e_amp*1.4, e_width:p.e_width*1.2}) },
    { key:'Afterload↑', mutate:(p)=>({...p, ivct:clamp(p.ivct*1.3,30,140), et:clamp(p.et*0.9,180,360), ivrt:clamp(p.ivrt*1.25,50,150)}) },
    { key:'Inotropy↓', mutate:(p)=>({...p, ivct:clamp(p.ivct*1.25,30,140), et:clamp(p.et*0.9,180,360)}) }
  ];

  function genQuestion(){
    const baseBeat = makeFlowBeat(baseParams);
    if(quizType==='hemo'){
      const tgt = hemoScenarios[Math.floor(Math.random()*hemoScenarios.length)];
      const modBeat = makeFlowBeat(tgt.mutate({...baseParams}));
      const options = [tgt.key, ...hemoScenarios.filter(h=>h.key!==tgt.key).slice(0,3).map(h=>h.key)]
        .sort(()=>Math.random()-0.5)
        .slice(0, nOptions);
      return { type:'hemo', baseBeat, modBeat, answer:tgt.key, options };
    } else {
      const modBeat = makeFlowBeat(baseParams);
      const T = baseParams.rr;
      const segs = [
        {label:'IVCT (all valves closed)', start: baseBeat.metrics.tMO- (baseBeat.metrics.ivrt+120), end: baseBeat.metrics.tAO, kind:'IVCT'},
        {label:'Ejection (Ao open)', start: baseBeat.metrics.tAO, end: baseBeat.metrics.tAC, kind:'Ejection'},
        {label:'IVRT (all valves closed)', start: baseBeat.metrics.tAC, end: baseBeat.metrics.tMO, kind:'IVRT'},
        {label:'Early rapid filling (E wave)', start: baseBeat.metrics.tE-50, end: baseBeat.metrics.tE+50, kind:'E'},
        {label:'Diastasis', start: baseBeat.metrics.tE+60, end: baseBeat.metrics.tA-60, kind:'Diastasis'},
        {label:'Atrial contraction (A wave)', start: baseBeat.metrics.tA-45, end: baseBeat.metrics.tA+45, kind:'A'}
      ].filter(s=>s.end>s.start && s.start>=0 && s.end<T);

      const tgt = segs[Math.floor(Math.random()*segs.length)];
      const choicesAll = ['IVCT','Ejection','IVRT','E','Diastasis','A'];
      const options = [tgt.kind, ...choicesAll.filter(c=>c!==tgt.kind).sort(()=>Math.random()-0.5)].slice(0,nOptions).sort(()=>Math.random()-0.5);
      return { type:'phase', baseBeat, modBeat, segment:tgt, answer:tgt.kind, options };
    }
  }

  useEffect(()=>{ if(!current) setCurrent(genQuestion()); },[current, rr, quizType, difficulty]);

  const isCorrect = showResult && selected===current?.answer;
  useConfettiOn(isCorrect);

  function submit(ans){
    if(showResult) return;
    setSelected(ans);
    setShowResult(true);
    setAnswered(x=>x+1);
    if(ans===current.answer) setScore(s=>s+1);
  }
  function nextQ(){
    setCurrent(genQuestion());
    setSelected(null);
    setShowResult(false);
  }
  function resetQuiz(){
    setScore(0); setAnswered(0);
    setCurrent(genQuestion());
    setSelected(null); setShowResult(false);
  }

  if(!current) return <div>Loading…</div>;

  const mod2 = useMemo(()=>tileBeats(current.modBeat,2),[current]);

  const xAxisLabel={ value:'time (ms)', position:'insideBottomRight', offset:-10 };
  const yAxisLabel={ value:'flow (m/s)', angle:-90, position:'insideLeft' };

  return (
    <div className="wrap">
      <canvas id="confetti-canvas"></canvas>

      <section className="section">
        <h2>Quiz Settings</h2>
        <div className="stack">
          <div className="field">
            <label className="label">Quiz type</label>
            <div className="mode-toggle" style={{margin:0}}>
              <button className={quizType==='phase'?'active':''} onClick={()=>{setQuizType('phase'); setCurrent(null);}} disabled={showResult}>Phase / Valve</button>
              <button className={quizType==='hemo'?'active':''} onClick={()=>{setQuizType('hemo'); setCurrent(null);}} disabled={showResult}>Hemodynamics</button>
            </div>
          </div>

          <div className="field">
            <label className="label">Difficulty</label>
            <div className="mode-toggle" style={{margin:0}}>
              <button className={difficulty==='easy'?'active':''} onClick={()=>{setDifficulty('easy'); setCurrent(null);}} disabled={showResult}>Easy (2)</button>
              <button className={difficulty==='standard'?'active':''} onClick={()=>{setDifficulty('standard'); setCurrent(null);}} disabled={showResult}>Standard (4)</button>
            </div>
          </div>

          <div className="field">
            <label className="label">Heart rate (bpm): {hr}</label>
            <input type="range" min="30" max="180" step="1" value={hr} onChange={(e)=>setHr(+e.target.value)} disabled={showResult}/>
          </div>

          <div className="divider"></div>

          <div className="score-display">
            <div>Score: {score}/{answered}</div>
            <div>{answered>0 ? `${Math.round(score/answered*100)}%` : '—'}</div>
          </div>

          <button onClick={resetQuiz}>Reset Quiz</button>

          <div className="divider"></div>

          <div>
            {quizType==='hemo' ? (
              <h3 style={{marginBottom:12,fontSize:14,fontWeight:600}}>
                Which hemodynamic change produced the modified trace?
              </h3>
            ) : (
              <h3 style={{marginBottom:12,fontSize:14,fontWeight:600}}>
                What phase/valve state is highlighted?
              </h3>
            )}

            <div className="quiz-options-grid">
              {current.options.map(opt=>(
                <button
                  key={opt}
                  className={`quiz-option ${
                    showResult
                      ? (opt===current.answer ? 'correct' : opt===selected ? 'incorrect' : '')
                      : ''
                  } ${showResult ? 'disabled' : ''}`}
                  onClick={()=>submit(opt)}
                  disabled={showResult}
                >
                  {opt}
                </button>
              ))}
            </div>
          </div>

          {showResult && (
            <>
              <div style={{padding:12,background:isCorrect?'#f0fdf4':'#fef2f2',borderRadius:6,fontWeight:600, marginTop:8, marginBottom:8}}>
                {isCorrect ? '✓ Correct!' : `✗ Incorrect. The answer was: ${current.answer}`}
              </div>

              {/* Insights for quiz: plain language mapping */}
              <div className="insights">
                <div style={{fontWeight:700, marginBottom:6}}>Why this answer?</div>
                <ul style={{margin:'6px 0 0 18px',fontSize:14}}>
                  {quizType==='phase' && current.segment && (
                    <>
                      <li><b>{current.segment.label}</b> sits between valve transitions (e.g., IVCT: MC closed → AO opens; IVRT: AC → MO).</li>
                      <li>Transmitral <b>E</b> is early filling; <b>A</b> is atrial contraction; <b>Diastasis</b> is low-flow rest at slower HR.</li>
                    </>
                  )}
                  {quizType==='hemo' && (
                    <>
                      <li><b>HR↑</b> → shorter RR, reduced diastasis, possible E/A fusion.</li>
                      <li><b>Preload↑</b> → ↑E amplitude/width (greater early filling).</li>
                      <li><b>Afterload↑</b> → ↑IVCT, ↓ET, ↑IVRT (harder to open/close against pressure).</li>
                      <li><b>Inotropy↓</b> → ↑IVCT, ↓ET (weaker contraction).</li>
                    </>
                  )}
                </ul>
              </div>

              <button className="primary" onClick={nextQ}>Next Question</button>
            </>
          )}
        </div>
      </section>

      <section className="section">
        <h2>Flow Trace</h2>
        <div className="legend">
          <span className="pill"><span className="line"></span> Modified</span>
        </div>
        <ResponsiveContainer width="100%" height={360}>
          <LineChart data={mod2} margin={{top:8,right:30,bottom:20,left:25}}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis type="number" dataKey="t" domain={[0,'dataMax']} tickCount={10}
                   label={{value:'time (ms)', position:'insideBottomRight', offset:-10}}/>
            <YAxis domain={[0,2.4]} tickCount={6}
                   label={{value:'flow (m/s)', angle:-90, position:'insideLeft'}}/>
            <Tooltip formatter={(v, n)=>`${n}: ${Number(v).toFixed(2)} m/s`} labelFormatter={(l)=>`${Number(l).toFixed(0)} ms`} />
            <Line dot={false} type="monotone" dataKey="mitral" name="Transmitral" stroke="#0f172a" strokeWidth={3}/>
            <Line dot={false} type="monotone" dataKey="aortic" name="Aortic" stroke="#2563eb" strokeWidth={3}/>
            {quizType==='phase' && current.segment && (
              <ReferenceArea x1={current.segment.start} x2={current.segment.end} strokeOpacity={0.2} />
            )}
          </LineChart>
        </ResponsiveContainer>
        <div style={{fontSize:12, color:'var(--muted)', marginTop:6}}>
          Phase boundaries and valve states follow the Wiggers diagram convention.
        </div>
      </section>
    </div>
  );
}

/* ---------------- Main App ---------------- */
function App(){
  const [mode,setMode]=useState('explore');
  return (
    <>
      <div className="mode-toggle" style={{marginBottom:16}}>
        <button className={mode==='explore'?'active':''} onClick={()=>setMode('explore')}>Explore Mode</button>
        <button className={mode==='quiz'?'active':''} onClick={()=>setMode('quiz')}>Quiz Mode</button>
      </div>
      {mode==='explore' ? <ExploreMode/> : <QuizMode/>}
    </>
  );
}

ReactDOM.createRoot(document.getElementById('flow-app')).render(<App/>);
</script>
{% endraw %}
